-- Errors and other research
SHOW WAREHOUSES LIKE 'AI_REPORTS%';

select * from dcs_master.public.applications where aid in ('Db4aw7p6pe');

SELECT COUNT(SESSION_ID)
FROM query_history
WHERE USER_NAME = 'AI_REPORTS_PROD'
    AND START_TIME >= dateadd('hour', -24, current_timestamp())
    AND WAREHOUSE_NAME LIKE 'AI_REPORTS_COMPOSER_CONVERSIONS_BREAKDOWN_PV%';

SELECT
    --*
    QUERY_ID, QUERY_TEXT, DATABASE_NAME, ERROR_MESSAGE, USER_NAME, ROLE_NAME, WAREHOUSE_NAME, QUERY_TAG
    --SUBSTR(QUERY_TEXT, POSITION('FROM', QUERY_TEXT) + 5, POSITION('.DATA.card_exec', QUERY_TEXT) - POSITION('FROM', QUERY_TEXT) - 5) AS PUBLISHER,
    --QUERY_TEXT, SESSION_ID, START_TIME, TOTAL_ELAPSED_TIME, DATABASE_NAME, USER_NAME, ROLE_NAME, WAREHOUSE_NAME, EXECUTION_STATUS, QUERY_TAG
FROM query_history
WHERE START_TIME >= dateadd('hour', -24, current_timestamp()) /*AND START_TIME < dateadd('hour', -1, current_timestamp())*/
    AND EXECUTION_STATUS = 'FAIL'
    --AND DATABASE_NAME = 'SACHSISCHE_EU'
    --AND USER_NAME = 'SYSTEM'
    AND USER_NAME = 'AI_REPORTS_PROD'
    --AND WAREHOUSE_NAME IN ('AI_REPORTS_ACTIVITY_S_01', 'AI_REPORTS_ACTIVITY_XS_01')
    --AND USER_NAME = 'DCS_SNOWMASTER_PROD'
    --AND WAREHOUSE_NAME LIKE 'AI_REPORTS_FLOW%'
    --AND WAREHOUSE_NAME LIKE 'AI_REPORTS_SUSPICIOUS_ACTIVITY%'
    --AND USER_NAME = 'DATADOG_USER_PROD'
    /*AND QUERY_TAG = 'subject=vx-conversion-chunks aid=xZyCF7VIpu from=20230120230100 to=20230130230100'*/
    --AND START_TIME >= '2023-02-22'
    --AND ERROR_MESSAGE NOT LIKE '%EXPERIENCE%'
    --AND TOTAL_ELAPSED_TIME > 10000
ORDER BY START_TIME DESC LIMIT 100;
--ORDER BY TOTAL_ELAPSED_TIME DESC LIMIT 500;

-- Activity report stats
SELECT SUBSTR(QUERY_TEXT, POSITION('FROM', QUERY_TEXT) + 5, POSITION('.DATA.card_exec', QUERY_TEXT) - POSITION('FROM', QUERY_TEXT) - 5) AS PUBLISHER, DATE(START_TIME), COUNT(1)
FROM query_history
WHERE START_TIME >= '2023-04-05 00:00:00.000 -0800' AND WAREHOUSE_NAME IN ('AI_REPORTS_ACTIVITY_S_01', 'AI_REPORTS_ACTIVITY_XS_01') AND PUBLISHER <> ''
GROUP BY PUBLISHER, DATE(START_TIME)
ORDER BY PUBLISHER, DATE(START_TIME);

SELECT SUM(TOTAL_ELAPSED_TIME), SUM(EXECUTION_TIME)
FROM query_history
WHERE USER_NAME = 'AI_REPORTS_PROD'
	--AND START_TIME >= dateadd('hour', -2, current_timestamp())
	--AND START_TIME < dateadd('hour', -1, current_timestamp())
	AND START_TIME >= '2023-03-02 21:00:00.000 -0800'
	AND START_TIME < '2023-03-02 21:59:00.000 -0800'
	--AND QUERY_TAG LIKE 'subject=vx-conversion-chunks%'
	AND WAREHOUSE_NAME = 'AI_REPORTS_VX_CONVERSIONS_M_01';
--ORDER BY TOTAL_ELAPSED_TIME DESC
--ORDER BY START_TIME DESC
--GROUP BY TOTAL_ELAPSED_TIME;

SELECT WAREHOUSE_NAME AS sf_warehouse_name, SUM(CREDITS_USED_COMPUTE) AS sf_warehouse_compute_credits_per_hour
FROM WAREHOUSE_METERING_HISTORY
WHERE START_TIME >= dateadd('hour', -11, current_timestamp()) AND START_TIME < dateadd('hour', -3, current_timestamp())
GROUP BY WAREHOUSE_NAME;

SELECT *
FROM WAREHOUSE_METERING_HISTORY
WHERE START_TIME >= dateadd('hour', -4, current_timestamp()) AND START_TIME < dateadd('hour', -3, current_timestamp())
ORDER BY START_TIME DESC
LIMIT 10;

SELECT
	TIMEDIFF(hour, START_TIME, current_timestamp()) AS HRS_AGO,
    WAREHOUSE_NAME, QUERY_TEXT, START_TIME, DATABASE_NAME, QUERY_TAG, EXECUTION_STATUS, TOTAL_ELAPSED_TIME
    --DATABASE_NAME, COUNT(DATABASE_NAME)
    --*
FROM
	query_history
WHERE
	--START_TIME >= '2024-01-01'
    START_TIME >= dateadd('day', -3, current_timestamp())
	--AND WAREHOUSE_NAME LIKE 'AI_REPORTS_AB_TEST_M%'
    --AND WAREHOUSE_NAME LIKE 'AI_REPORTS_FLOW_M%'
    AND WAREHOUSE_NAME LIKE 'AI_REPORTS_SUSPICIOUS%'
    --AND DATABASE_NAME <> 'DCS_MASTER'
    AND DATABASE_NAME = 'ALLER_ZEITUNG'
    --AND QUERY_TYPE = 'SELECT'
    --AND QUERY_TAG LIKE 'subject=lts%'
    --AND DATABASE_NAME IN ('SUEDDEUTSCHE_ZEITUNG_PRE_PROD')
    --AND EXECUTION_STATUS <> 'SUCCESS'
    AND QUERY_TAG LIKE 'subject=suspicious-activity-%'
--ORDER BY TOTAL_ELAPSED_TIME DESC
--GROUP BY DATABASE_NAME
--ORDER BY COUNT(DATABASE_NAME) DESC;
ORDER BY START_TIME DESC
LIMIT 200;

-- look for errors
SELECT TIMEDIFF(hour, START_TIME, current_timestamp()) AS HRS_AGO, DATABASE_NAME, WAREHOUSE_NAME, TOTAL_ELAPSED_TIME, EXECUTION_STATUS, ERROR_CODE, ERROR_MESSAGE
FROM query_history
WHERE
    START_TIME >= dateadd('day', -1, current_timestamp())
    AND EXECUTION_STATUS <> 'SUCCESS'
    --AND ERROR_CODE = '000630'
ORDER BY ERROR_CODE
LIMIT 200;

-- look for timeouts
SELECT
    WAREHOUSE_NAME, SUM(1)
FROM
    query_history
WHERE
    START_TIME >= dateadd('day', -2, current_timestamp())
    AND ERROR_CODE = '000630'
GROUP BY WAREHOUSE_NAME;

-- look for specific user
SELECT QUERY_TEXT, DATABASE_NAME, QUERY_TAG
FROM query_history
WHERE USER_NAME = 'VLADISLAV_MYACHIKOV_PROD'
    AND START_TIME >= dateadd('hour', -24, current_timestamp())
ORDER BY START_TIME DESC;


----
-- Cost estimation (reports)
-- Query for cost by warehouse
SELECT
    --WAREHOUSE_NAME AS sf_warehouse_name,
    --SUM(CREDITS_USED_COMPUTE) AS sf_warehouse_compute_credits_per_hour
    *
FROM
    WAREHOUSE_METERING_HISTORY
WHERE
    START_TIME >= dateadd('hour', -4, current_timestamp())
    AND START_TIME < dateadd('hour', -3, current_timestamp())
--GROUP BY WAREHOUSE_NAME;
LIMIT 10;

-- Query to check history of executions
SELECT --*
    LEFT(QUERY_TEXT, 100) as CUT,
    COUNT(CUT)
    --COUNT(1)
    --QUERY_ID, QUERY_TEXT, DATABASE_NAME, ERROR_MESSAGE, USER_NAME, ROLE_NAME, WAREHOUSE_NAME, QUERY_TAG
    --SUBSTR(QUERY_TEXT, POSITION('FROM', QUERY_TEXT) + 5, POSITION('.DATA.card_exec', QUERY_TEXT) - POSITION('FROM', QUERY_TEXT) - 5) AS PUBLISHER,
    --QUERY_TEXT, SESSION_ID, START_TIME, TOTAL_ELAPSED_TIME, DATABASE_NAME, USER_NAME, ROLE_NAME, WAREHOUSE_NAME, EXECUTION_STATUS, QUERY_TAG
    --WAREHOUSE_NAME, COUNT(WAREHOUSE_NAME)
    --WAREHOUSE_NAME,
    --SPLIT(WAREHOUSE_NAME, '_')[ARRAY_SIZE(SPLIT(WAREHOUSE_NAME, '_')) - 2] as WH_SIZE
FROM query_history
WHERE START_TIME >= dateadd('hour', -24, current_timestamp())
    --AND WAREHOUSE_NAME LIKE 'AI_REPORTS_%'
    AND WAREHOUSE_NAME LIKE 'AI_REPORTS_COMPOSER_VERSIONS_%'
    --AND (DATABASE_NAME is NULL OR DATABASE_NAME = '') -- LTS and Activity 
    AND DATABASE_NAME = 'DCS_MASTER'
--ORDER BY QUERY_TEXT
GROUP BY CUT;
--LIMIT 100;

-- Query to estimate the cost
WITH stats AS (
    SELECT
        DATABASE_NAME,
        ARRAY_REMOVE_AT(ARRAY_REMOVE_AT(SPLIT(WAREHOUSE_NAME, '_'), 0), 0) as WH_SPLIT,
        WH_SPLIT[ARRAY_SIZE(WH_SPLIT) - 2] as WH_SIZE,
        TOTAL_ELAPSED_TIME,
        CASE
            WHEN WAREHOUSE_NAME LIKE 'AI_REPORTS_AB_TEST_%' THEN 'A/B Test'
            WHEN WAREHOUSE_NAME LIKE 'AI_REPORTS_AAM_%' THEN 'AAM'
            WHEN WAREHOUSE_NAME LIKE 'AI_REPORTS_ACTIVITY_%' THEN 'Activity'
            WHEN WAREHOUSE_NAME LIKE 'AI_REPORTS_CHURN_PREVENTION_%' THEN 'Churn Prevention'
            WHEN WAREHOUSE_NAME LIKE 'AI_REPORTS_COMPOSER_CONVERSIONS_%' THEN 'Conversions (Composer)'
            WHEN WAREHOUSE_NAME LIKE 'AI_REPORTS_VX_CONVERSIONS_%' THEN 'Conversions (VX)'
            WHEN WAREHOUSE_NAME LIKE 'AI_REPORTS_EMAIL_%' THEN 'Email'
            WHEN WAREHOUSE_NAME LIKE 'AI_REPORTS_FLOW_%' THEN 'Flow'
            WHEN WAREHOUSE_NAME LIKE 'AI_REPORTS_LTS_%' THEN 'LTS'
            WHEN WAREHOUSE_NAME LIKE 'AI_REPORTS_COMPOSER_VERSIONS_%' THEN 'Versions (common)'
            WHEN WAREHOUSE_NAME LIKE 'AI_REPORTS_REVREC_%' THEN 'Revenue Recognition'
            WHEN WAREHOUSE_NAME LIKE 'AI_REPORTS_SUBSCRIPTION_%' THEN 'Subscription Log'
            WHEN WAREHOUSE_NAME LIKE 'AI_REPORTS_SUSPICIOUS_ACTIVITY_%' THEN 'Suspicious Activity'
            ELSE 'Other'
        END as REPORT_NAME,
        CASE
            WHEN WH_SIZE = 'XS' THEN 0.0003
            WHEN WH_SIZE = 'S'  THEN 0.0006
            WHEN WH_SIZE = 'M'  THEN 0.0011
            WHEN WH_SIZE = 'L'  THEN 0.0022
            WHEN WH_SIZE = 'XL' THEN 0.0044
            ELSE 0
        END as CREDITS
    FROM query_history
    WHERE START_TIME >= dateadd('day', -1, current_timestamp())
        --START_TIME >= '2023-01-01' AND START_TIME < '2023-02-01'
        AND WAREHOUSE_NAME LIKE 'AI_REPORTS_%'
        AND DATABASE_NAME is not NULL
        AND DATABASE_NAME != 'DCS_MASTER'
        AND WAREHOUSE_NAME LIKE 'AI_REPORTS_COMPOSER_CONVERSIONS_%'
    --LIMIT 10
)

SELECT m.MERCHANT_ID, s.DATABASE_NAME, m.MERCHANT_NAME, s.REPORT_NAME, SUM(s.TOTAL_ELAPSED_TIME*s.CREDITS)*1.65/1000 as USD
FROM stats s JOIN DCS_MASTER.PUBLIC.MERCHANTS m ON s.DATABASE_NAME = m.DATABASE_NAME
GROUP BY s.DATABASE_NAME, s.REPORT_NAME, m.MERCHANT_ID, m.MERCHANT_NAME
ORDER BY USD DESC, s.DATABASE_NAME, s.REPORT_NAME;


--subquery of the above
SELECT
    *
FROM query_history
WHERE START_TIME >= dateadd('day', -2, current_timestamp())
    --START_TIME >= '2023-01-01' AND START_TIME < '2023-02-01'
    --AND WAREHOUSE_NAME LIKE 'AI_REPORTS_%'
    --AND WAREHOUSE_NAME NOT LIKE 'AI_REPORTS_COMPOSER_VERSIONS%'
    AND WAREHOUSE_NAME LIKE 'AI_REPORTS_ACTIVITY_%'
    --AND QUERY_TAG LIKE '% aid=%'
    --AND DATABASE_NAME = 'DCS_MASTER'
LIMIT 100;